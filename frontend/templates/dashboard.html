{% extends "base.html" %}

{% block title %}Dashboard - SuperNote{% endblock %}

{% block page_title %}CNN{% endblock %}

{% block content %}
<div class="summary-grid" id="summaryGrid">
    <!-- Summary cards will be populated here -->
</div>

<div id="emptyState" class="empty-state" style="display: none;">
    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 20px; color: var(--text-light);"></i>
    <h3>No summaries yet</h3>
    <p>Create your first summary to get started</p>
    <a href="/create-summary" class="btn-primary" style="margin-top: 20px; display: inline-block;">Create Summary</a>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let allSummaries = [];
    let currentFilter = 'recent';
    
    // Load summaries on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (checkAuth()) {
            loadSummaries();
        }
    });
    
    // Load summaries from API
    async function loadSummaries() {
        try {
            const token = localStorage.getItem('token');
            
            // Get regular notes
            const notesResponse = await fetch('/api/notes', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            // Get supernotes
            const supernotesResponse = await fetch('/api/supernotes', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            let notes = [];
            let supernotes = [];
            
            if (notesResponse.ok) {
                const notesData = await notesResponse.json();
                notes = notesData.notes || [];
            }
            
            if (supernotesResponse.ok) {
                const supernotesData = await supernotesResponse.json();
                supernotes = supernotesData.supernotes || [];
            }
            
            // Combine and format all summaries
            allSummaries = [
                ...notes.map(note => ({
                    id: note._id,
                    title: note.Header,
                    content: note.Sum,
                    provider: note.Provider,
                    date: note.DateTime,
                    type: 'note',
                    favorite: note.favorite || false
                })),
                ...supernotes.map(supernote => ({
                    id: supernote._id,
                    title: supernote.Header,
                    content: supernote.Sum,
                    provider: supernote.Provider,
                    date: supernote.DateTime,
                    type: 'supernote',
                    favorite: supernote.favorite || false
                }))
            ];
            
            renderSummaries();
        } catch (error) {
            console.error('Error loading summaries:', error);
            showEmptyState();
        }
    }
    
    // Render summaries based on current filter
    function renderSummaries() {
        const grid = document.getElementById('summaryGrid');
        const emptyState = document.getElementById('emptyState');
        
        let filteredSummaries = [...allSummaries];
        
        // Apply filter
        switch (currentFilter) {
            case 'recent':
                filteredSummaries.sort((a, b) => new Date(b.date) - new Date(a.date));
                break;
            case 'oldest':
                filteredSummaries.sort((a, b) => new Date(a.date) - new Date(b.date));
                break;
            case 'favorites':
                filteredSummaries = filteredSummaries.filter(s => s.favorite);
                break;
        }
        
        if (filteredSummaries.length === 0) {
            showEmptyState();
            return;
        }
        
        grid.innerHTML = '';
        emptyState.style.display = 'none';
        
        filteredSummaries.forEach(summary => {
            const card = createSummaryCard(summary);
            grid.appendChild(card);
        });
    }
    
    // Create a summary card element
    function createSummaryCard(summary) {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.onclick = () => viewSummary(summary.id);
        
        const formattedDate = formatDate(summary.date);
        const truncatedContent = truncateText(summary.content, 150);
        
        card.innerHTML = `
            <div class="card-header">
                <h3 class="card-title">${escapeHtml(summary.title)}</h3>
            </div>
            <div class="card-content">
                ${escapeHtml(truncatedContent)}
            </div>
            <div class="card-footer">
                <div class="card-meta">
                    <div>${formattedDate}</div>
                    <div>by ${escapeHtml(summary.provider)}</div>
                </div>
                <div class="card-actions">
                    <button class="action-btn favorite ${summary.favorite ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleFavorite('${summary.id}')">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="action-btn edit" 
                            onclick="event.stopPropagation(); editSummary('${summary.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" 
                            onclick="event.stopPropagation(); deleteSummary('${summary.id}', '${summary.type}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // Show empty state
    function showEmptyState() {
        document.getElementById('summaryGrid').innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
    }
    
    // View summary
    function viewSummary(id) {
        window.location.href = `/view-summary/${id}`;
    }
    
    // Edit summary
    function editSummary(id) {
        window.location.href = `/edit-summary/${id}`;
    }
    
    // Toggle favorite status
    async function toggleFavorite(id) {
        // This would require a new API endpoint to toggle favorites
        // For now, just update the UI
        const summary = allSummaries.find(s => s.id === id);
        if (summary) {
            summary.favorite = !summary.favorite;
            renderSummaries();
        }
    }
    
    // Delete summary
    async function deleteSummary(id, type) {
        if (!confirm('Are you sure you want to delete this summary?')) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const endpoint = type === 'supernote' ? `/api/supernote/${id}` : `/api/note/${id}`;
            
            const response = await fetch(endpoint, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                // Remove from local array and re-render
                allSummaries = allSummaries.filter(s => s.id !== id);
                renderSummaries();
            } else {
                alert('Error deleting summary');
            }
        } catch (error) {
            console.error('Error deleting summary:', error);
            alert('Error deleting summary');
        }
    }
    
    // Filter change handler
    document.getElementById('filterSelect').addEventListener('change', function() {
        currentFilter = this.value;
        renderSummaries();
    });
    
    // Sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            
            // Update filter based on clicked item
            const filter = this.dataset.filter;
            if (filter) {
                currentFilter = filter;
                document.getElementById('filterSelect').value = filter;
                renderSummaries();
            }
        });
    });
    
    // Utility functions
    function formatDate(dateString) {
        try {
            // Handle DD/MM/YYYY HH:MM:SS format
            const parts = dateString.split(' ');
            if (parts.length === 2) {
                const [datePart, timePart] = parts;
                const [day, month, year] = datePart.split('/');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString();
            }
            return new Date(dateString).toLocaleDateString();
        } catch {
            return dateString;
        }
    }
    
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + '...';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
