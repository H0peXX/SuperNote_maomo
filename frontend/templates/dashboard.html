{% extends "base.html" %}

{% block title %}Dashboard - SuperNote{% endblock %}

{% block page_title %}CNN{% endblock %}

{% block content %}
<div class="summary-grid" id="summaryGrid">
    <!-- Summary cards will be populated here -->
</div>

<div id="emptyState" class="empty-state" style="display: none;">
    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 20px; color: var(--text-light);"></i>
    <h3>No summaries yet</h3>
    <p>Create your first summary to get started</p>
    <a href="/create-summary" class="btn-primary" style="margin-top: 20px; display: inline-block;">Create Summary</a>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let allSummaries = [];
    let currentFilter = 'recent-notes';
    
    // Load summaries on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (checkAuth()) {
            loadSummaries();
        }
    });
    
    // Load summaries from API
    async function loadSummaries() {
        try {
            const token = localStorage.getItem('token');
            
            // Get regular notes
            const notesResponse = await fetch('/api/notes', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            // Get supernotes
            const supernotesResponse = await fetch('/api/supernotes', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            let notes = [];
            let supernotes = [];
            
            if (notesResponse.ok) {
                const notesData = await notesResponse.json();
                notes = notesData.notes || [];
            }
            
            if (supernotesResponse.ok) {
                const supernotesData = await supernotesResponse.json();
                supernotes = supernotesData.supernotes || [];
            }
            
            // Combine and format all summaries with null safety
            allSummaries = [
                ...notes.map(note => ({
                    id: note._id || 'unknown',
                    title: note.Header || 'Untitled Note',
                    content: note.Sum || 'No content available',
                    provider: note.Provider || 'Unknown',
                    date: note.DateTime || new Date().toLocaleDateString(),
                    type: 'note',
                    favorite: note.favorite || false
                })),
                ...supernotes.map(supernote => ({
                    id: supernote._id || 'unknown',
                    title: supernote.Header || 'Untitled Super Note',
                    content: supernote.Sum || 'No content available',
                    provider: supernote.Provider || 'Unknown',
                    date: supernote.DateTime || new Date().toLocaleDateString(),
                    type: 'supernote',
                    favorite: supernote.favorite || false
                }))
            ];
            
            renderSummaries();
        } catch (error) {
            console.error('Error loading summaries:', error);
            showEmptyState();
        }
    }
    
    // Render summaries based on current filter
    function renderSummaries() {
        const grid = document.getElementById('summaryGrid');
        const emptyState = document.getElementById('emptyState');
        
        let filteredSummaries = [...allSummaries];
        
        // Update page title based on current filter
        updatePageTitle(currentFilter);
        
        // Apply filter
        switch (currentFilter) {
            case 'recent-notes':
                filteredSummaries = filteredSummaries.filter(s => s.type === 'note');
                filteredSummaries.sort((a, b) => parseCustomDate(b.date) - parseCustomDate(a.date));
                break;
            case 'favorite-notes':
                filteredSummaries = filteredSummaries.filter(s => s.type === 'note' && s.favorite);
                filteredSummaries.sort((a, b) => parseCustomDate(b.date) - parseCustomDate(a.date));
                break;
            case 'recent-supernotes':
                filteredSummaries = filteredSummaries.filter(s => s.type === 'supernote');
                filteredSummaries.sort((a, b) => parseCustomDate(b.date) - parseCustomDate(a.date));
                break;
            case 'favorite-supernotes':
                filteredSummaries = filteredSummaries.filter(s => s.type === 'supernote' && s.favorite);
                filteredSummaries.sort((a, b) => parseCustomDate(b.date) - parseCustomDate(a.date));
                break;
        }
        
        if (filteredSummaries.length === 0) {
            showEmptyState();
            return;
        }
        
        grid.innerHTML = '';
        emptyState.style.display = 'none';
        
        filteredSummaries.forEach(summary => {
            const card = createSummaryCard(summary);
            grid.appendChild(card);
        });
    }
    
    // Create a summary card element
    function createSummaryCard(summary) {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.onclick = () => viewSummary(summary.id);
        
        const formattedDate = formatDate(summary.date);
        const truncatedContent = truncateText(summary.content, 150);
        
        card.innerHTML = `
            <div class="card-header">
                <h3 class="card-title">${escapeHtml(summary.title)}</h3>
            </div>
            <div class="card-content">
                ${escapeHtml(truncatedContent)}
            </div>
            <div class="card-footer">
                <div class="card-meta">
                    <div>${formattedDate}</div>
                    <div>by ${escapeHtml(summary.provider)}</div>
                </div>
                <div class="card-actions">
                    <button class="action-btn favorite ${summary.favorite ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleFavorite('${summary.id}')">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="action-btn edit" 
                            onclick="event.stopPropagation(); editSummary('${summary.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" 
                            onclick="event.stopPropagation(); deleteSummary('${summary.id}', '${summary.type}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // Show empty state
    function showEmptyState() {
        document.getElementById('summaryGrid').innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
    }
    
    // View summary
    function viewSummary(id) {
        window.location.href = `/view-summary/${id}`;
    }
    
    // Edit summary
    function editSummary(id) {
        window.location.href = `/edit-summary/${id}`;
    }
    
    // Toggle favorite status
    async function toggleFavorite(id) {
        try {
            const token = localStorage.getItem('token');
            const summary = allSummaries.find(s => s.id === id);
            if (!summary) return;
            
            const endpoint = summary.type === 'supernote' 
                ? `/api/supernote/${id}/favorite` 
                : `/api/note/${id}/favorite`;
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                // Update local array with server response
                summary.favorite = result.favorite;
                renderSummaries();
            } else {
                alert('Error updating favorite status');
            }
        } catch (error) {
            console.error('Error toggling favorite:', error);
            alert('Error updating favorite status');
        }
    }
    
    // Delete summary
    async function deleteSummary(id, type) {
        if (!confirm('Are you sure you want to delete this summary?')) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const endpoint = type === 'supernote' ? `/api/supernote/${id}` : `/api/note/${id}`;
            
            const response = await fetch(endpoint, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                // Remove from local array and re-render
                allSummaries = allSummaries.filter(s => s.id !== id);
                renderSummaries();
            } else {
                alert('Error deleting summary');
            }
        } catch (error) {
            console.error('Error deleting summary:', error);
            alert('Error deleting summary');
        }
    }
    
    // Filter change handler
    document.getElementById('filterSelect').addEventListener('change', function() {
        currentFilter = this.value;
        renderSummaries();
    });
    
    // Sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            
            // Update filter based on clicked item
            const filter = this.dataset.filter;
            if (filter) {
                // Map sidebar filters to dropdown filters
                let dropdownFilter = filter;
                if (filter === 'favorite') {
                    dropdownFilter = 'favorites';
                } else if (filter.includes('supernotes') || filter.includes('notes')) {
                    // For specific notes/supernotes filters, keep the filter as is
                    dropdownFilter = filter;
                }
                
                currentFilter = dropdownFilter;
                document.getElementById('filterSelect').value = dropdownFilter;
                renderSummaries();
            }
        });
    });
    
    // Update page title based on current filter
    function updatePageTitle(filter) {
        const titleElement = document.querySelector('.dynamic-title');
        if (!titleElement) return;
        
        let newTitle = 'Notes';
        switch (filter) {
            case 'recent-notes':
                newTitle = 'Notes';
                break;
            case 'favorite-notes':
                newTitle = 'Favorite Notes';
                break;
            case 'recent-supernotes':
                newTitle = 'Super Notes';
                break;
            case 'favorite-supernotes':
                newTitle = 'Favorite Super Notes';
                break;
            default:
                newTitle = 'Notes';
        }
        
        titleElement.textContent = newTitle;
    }
    
    // Utility functions
    function parseCustomDate(dateString) {
        try {
            // Handle DD/MM/YYYY HH:MM:SS format
            const parts = dateString.split(' ');
            if (parts.length === 2) {
                const [datePart, timePart] = parts;
                const [day, month, year] = datePart.split('/');
                return new Date(year, month - 1, day, ...timePart.split(':').map(Number));
            }
            return new Date(dateString);
        } catch {
            return new Date(0); // Return epoch if parsing fails
        }
    }
    
    function formatDate(dateString) {
        try {
            // Handle DD/MM/YYYY HH:MM:SS format
            const parts = dateString.split(' ');
            if (parts.length === 2) {
                const [datePart, timePart] = parts;
                const [day, month, year] = datePart.split('/');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString();
            }
            return new Date(dateString).toLocaleDateString();
        } catch {
            return dateString;
        }
    }
    
    function truncateText(text, maxLength) {
        if (!text || text === null || text === undefined) return 'No content available';
        if (typeof text !== 'string') text = String(text);
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + '...';
    }
    
    function escapeHtml(text) {
        if (!text || text === null || text === undefined) return '';
        if (typeof text !== 'string') text = String(text);
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
