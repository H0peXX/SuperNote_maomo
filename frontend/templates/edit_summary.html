{% extends "base.html" %}

{% block title %}Edit Summary - SuperNote{% endblock %}

{% block page_title %}Edit Summary{% endblock %}

{% block content %}
<div class="form-container">
    <div class="loading" id="loadingState">
        <div class="spinner"></div>
        Loading summary...
    </div>
    
    <form id="edit-summary-form" class="edit-form" style="display: none;">
        <div class="form-group">
            <label for="title">Summary Title</label>
            <input type="text" id="title" class="title-input" placeholder="Enter title here..." required>
        </div>
        <div class="form-group">
            <label for="content">Summary Content</label>
            <textarea id="content" class="content-textarea" placeholder="Enter summary content here..." required></textarea>
        </div>
        <button type="submit" class="btn-save">Save Changes</button>
    </form>
    
    <div id="errorState" style="display: none;">
        <div class="status-message error">
            <p>Error loading summary. Please try again.</p>
            <button class="btn-primary" onclick="window.location.href='/dashboard'">Back to Dashboard</button>
        </div>
    </div>
</div>
{% endblock %}

<style>
/* Edit Page Specific Styles */
.form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.edit-form {
    background: var(--surface-color, #fff);
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-color, #333);
    font-size: 14px;
}

.title-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color, #e1e5e9);
    border-radius: 8px;
    font-size: 16px;
    background: var(--background-color, #fff);
    color: var(--text-color, #333);
    transition: border-color 0.2s, box-shadow 0.2s;
}

.title-input:focus {
    outline: none;
    border-color: var(--primary-color, #007bff);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.content-textarea {
    width: 100%;
    height: calc(100vh - 350px); /* Fill remaining viewport height */
    min-height: 300px;
    padding: 16px;
    border: 2px solid var(--border-color, #e1e5e9);
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--background-color, #fff);
    color: var(--text-color, #333);
    resize: vertical;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.content-textarea:focus {
    outline: none;
    border-color: var(--primary-color, #007bff);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.btn-save {
    background: var(--primary-color, #007bff);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-save:hover {
    background: var(--primary-color-dark, #0056b3);
    transform: translateY(-1px);
}

.btn-save:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: var(--text-light, #666);
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border-color, #e1e5e9);
    border-top: 3px solid var(--primary-color, #007bff);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-message {
    text-align: center;
    padding: 40px 20px;
    border-radius: 8px;
}

.status-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.btn-primary {
    background: var(--primary-color, #007bff);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-top: 16px;
    transition: background-color 0.2s;
}

.btn-primary:hover {
    background: var(--primary-color-dark, #0056b3);
}

/* Responsive design */
@media (max-width: 768px) {
    .form-container {
        padding: 16px;
    }
    
    .edit-form {
        padding: 20px;
    }
    
    .content-textarea {
        min-height: 250px;
    }
}
</style>

{% block scripts %}
{{ super() }}
<script>
    let currentSummary = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        if (checkAuth()) {
            loadSummary();
        }
    });
    
    // Get summary ID from URL
    function getSummaryId() {
        const pathParts = window.location.pathname.split('/');
        return pathParts[pathParts.length - 1];
    }
    
    // Load summary data for editing
    async function loadSummary() {
        const summaryId = getSummaryId();
        const token = localStorage.getItem('token');
        
        try {
            // Try to get as regular note first
            let response = await fetch(`/api/note/${summaryId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            let summaryData = null;
            let summaryType = 'note';
            
            if (response.ok) {
                summaryData = await response.json();
            } else {
                // Try as supernote
                response = await fetch(`/api/supernote/${summaryId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    summaryData = await response.json();
                    summaryType = 'supernote';
                }
            }
            
            if (summaryData) {
                currentSummary = { ...summaryData, type: summaryType };
                displayEditForm(summaryData);
            } else {
                showErrorState();
            }
        } catch (error) {
            console.error('Error loading summary:', error);
            showErrorState();
        }
    }
    
    // Display edit form with current data
    function displayEditForm(summary) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('edit-summary-form').style.display = 'block';
        
        // Update page title
        document.querySelector('.dynamic-title').textContent = `Edit: ${summary.Header || 'Summary'}`;
        
        // Populate form fields
        document.getElementById('title').value = summary.Header || '';
        document.getElementById('content').value = summary.Sum || '';
    }
    
    // Show error state
    function showErrorState() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
    }
    
    // Handle form submission
    document.getElementById('edit-summary-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentSummary) {
            alert('Error: Summary data not loaded');
            return;
        }
        
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        
        if (!title || !content) {
            alert('Please fill in both title and content');
            return;
        }
        
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        // Show loading state
        submitBtn.innerHTML = '<div class="spinner"></div>Saving...';
        submitBtn.disabled = true;
        
        try {
            const token = localStorage.getItem('token');
            
            // Prepare update data
            const updateData = {
                Header: title,
                Sum: content,
                LastUpdate: new Date().toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(',', '')
            };
            
            const endpoint = currentSummary.type === 'supernote' 
                ? `/api/supernote/${currentSummary._id}` 
                : `/api/note/${currentSummary._id}`;
            
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                alert('Summary updated successfully!');
                window.location.href = `/view-summary/${currentSummary._id}`;
            } else {
                const error = await response.json();
                alert('Error updating summary: ' + (error.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating summary:', error);
            alert('Error updating summary. Please try again.');
        } finally {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // Auto-resize textarea
    document.getElementById('content').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
</script>
{% endblock %}
